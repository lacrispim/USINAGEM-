/**
 * =================================================================
 *                    Firebase Security Rules
 * =================================================================
 *
 * @autogenerated
 *
 * @cloud_service Firestore
 * @language "rules"
 * @version "2"
 *
 * It appears you are encountering an 'auth/operation-not-allowed' error.
 * This specific error is NOT caused by Firestore Security Rules. It means
 * that the sign-in method you are using (e.g., Email/Password) has not
 * been enabled in your Firebase project's Authentication settings.
 *
 * To fix this, please go to the Firebase Console, navigate to the
 * "Authentication" section, click the "Sign-in method" tab, and
 * enable the "Email/Password" provider.
 *
 * The rules below have been generated based on your application's data
 * model and will function correctly once the authentication provider is enabled.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. All user-generated
 * content is private and can only be accessed by the user who created it.
 * The rules ensure that users cannot read, write, or even discover the
 * existence of data belonging to other users.
 *
 * Data Structure:
 * All user data is nested under the `/users/{userId}` path. A user's
 * profile is stored in the root document, and their specific application
 * data (machiningRecords) is stored in a subcollection within that
 * document. This hierarchical structure provides strong data isolation.
 *
 * Key Security Decisions:
 * - User Enumeration is Disabled: Listing the top-level `/users`
 *   collection is explicitly forbidden to protect user privacy.
 * - Strict Ownership: All operations (read, write, delete) are gated
 *   by an ownership check, ensuring a user can only ever interact with
 *   their own data tree.
 * - Relational Integrity: On document creation, rules validate that key
 *   identifiers (like `userId`) are set correctly, linking the document
 *   to its owner in the path. These identifiers are immutable on update.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update/delete.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that a user document being created has an 'id' field
     * that matches the user's auth UID.
     */
    function isCreatingOwnUserDoc(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates that the 'id' field of a user document is not being changed.
     */
    function isUpdatingOwnUserDoc() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that a machining record being created has an 'id' and 'userId'
     * that match the path parameters. Enforces relational integrity.
     */
    function isCreatingOwnRecord(userId, recordId) {
      return request.resource.data.userId == userId && request.resource.data.id == recordId;
    }

    /**
     * Validates that the 'id' and 'userId' fields of a machining record
     * are not being changed during an update.
     */
    function isUpdatingOwnRecord() {
      return request.resource.data.userId == resource.data.userId && request.resource.data.id == resource.data.id;
    }


    // ----------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (get) A user can read their own profile: `db.collection('users').doc('my-uid').get()`
     * @deny (get) A user cannot read another user's profile: `db.collection('users').doc('another-uid').get()`
     * @deny (list) Listing all users is forbidden to prevent user enumeration.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isCreatingOwnUserDoc(userId);
      allow update: if isExistingOwner(userId) && isUpdatingOwnUserDoc();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages machining records, which are owned by a specific user.
     * @path /users/{userId}/machiningRecords/{recordId}
     * @allow (create) A user can create a new machining record in their own subcollection.
     * @allow (list) A user can list all machining records they have created.
     * @deny (get) A user cannot access a machining record owned by another user.
     * @principle Enforces document ownership and validates relational integrity.
     */
    match /users/{userId}/machiningRecords/{recordId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isCreatingOwnRecord(userId, recordId);
      allow update: if isExistingOwner(userId) && isUpdatingOwnRecord();
      allow delete: if isExistingOwner(userId);
    }
  }
}